{% extends 'master.html' %}
{% load static %}
<head>
    <link rel="stylesheet" href="{% static  'css/Globechat/index.css' %}">
</head>


{% block header %}
{% block title %} Globe {% endblock %}
{% endblock %}


{%block content %}
<!-- Message Container -->
<div class="row flex-grow-1">
    <div class="col message-container " style="height: 70vh; overflow-y: auto; background-color: rgb(31, 30, 30);">
        <div id="messages" class="p-3">
            <ul id="message-container">

            </ul>
            <!-- Messages will be loaded here via AJAX -->
        </div>
    </div>
</div>
 <!-- Input Container -->
<div class="row bg-dark p-2" style="height: 10vh;">
    <div class="col">
        <input type="hidden" id="Username" value="{{ user.username }}"> <!-- Hidden username input -->

            <div class="input-group">
                <input type="text" id="Message" class="form-control " placeholder="Type your message here...">
                <div class="input-group-append but">
                    <!-- <input type="submit" class="btn btn-primary" id="Send" value="Send" > -->
                    <button class="btn btn-primary"  id="send">Send</button>
                </div>
            </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- <script src="{% static 'js/GlobeChat/index.js' %}"> -->
    <script>

async function fetchMessages() {
            await fetch('{% url "load_messages" %}')
            .then(response => response.json())
            .then(data => {
                const container = $('#message-container');
            container.empty(); // Clear previous messages
            data.forEach(function(msg) {
                const messageElement = $('<li class="list-group-item p-1 bg-dark border-bottom border-top"></li>');
                let username = $('<span class=""></span>').text(msg.username+":"+" ")
                username.css('color',msg.color)
                let content = $('<span></span>').text(msg.content)
                messageElement.append(username)
                messageElement.append(content)
                
                
                container.append(messageElement);
                
            });
        })
        .catch(error => console.error('Error fetching messages:', error));
    }
    
setInterval(fetchMessages, 500);

async function Send() {
        const usernameContent = document.getElementById('Username').value
        const messageInput = document.getElementById('Message');
        const messageContent = messageInput.value;
    
        if (messageContent.trim() === '') {
            return;
        }
    
        await fetch('{% url "send_message" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')  // Include CSRF token if CSRF protection is enabled
            },
            body: JSON.stringify({ 
                username:usernameContent,
                content: messageContent })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log('Message sent:', data);
            messageInput.value = ''; // Reset the input field
            // Optionally, you can update the messages display here
        })
        .catch(error => {
            console.error('Error sending message:', error);
        });
};

button = document.getElementById('send');
button.addEventListener('click',Send);
document.addEventListener('keydown',function(event){
    if (event.key === 'Enter'){
        button.click();
    }
})
// Function to get CSRF token from cookies (if needed)
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Check if this cookie string begins with the name we want
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
return cookieValue;
}
            </script>
        {% endblock %}
